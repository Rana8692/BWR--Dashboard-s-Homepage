<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Data Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .scorecard {
            background-color: white;
            border-radius: 0.5rem; 
            padding: 1rem; 
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06); 
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column; 
        }
        .scorecard:hover {
            transform: translateY(-3px); 
        }
        .scorecard-header {
            display: flex;
            align-items: center; 
            margin-bottom: 0.5rem; 
        }
        .scorecard-header svg {
            width: 1.25rem; 
            height: 1.25rem; 
            margin-right: 0.5rem; 
        }
        .scorecard h2 {
            font-size: 0.875rem; 
            color: #4b5563; 
            line-height: 1.3; 
            font-weight: 500; 
        }
        .scorecard p {
            font-size: 1.75rem; 
            font-weight: 600; 
            color: #1f2937; 
            margin-top: auto; 
        }
        .list-item {
            padding: 0.5rem 0.75rem; 
            border-bottom: 1px solid #e5e7eb; 
            display: flex; 
            align-items: center; 
            font-size: 0.875rem; 
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item svg { 
            width: 1rem; 
            height: 1rem; 
            margin-right: 0.5rem; 
            flex-shrink: 0; 
        }
        .section-title {
            font-size: 1.25rem; 
            font-weight: 600;
            color: #1f2937; 
            margin-bottom: 0.75rem; 
        }
        .scrollable-list::-webkit-scrollbar,
        .raw-data-table-container::-webkit-scrollbar {
            width: 6px; 
        }
        .scrollable-list::-webkit-scrollbar-track,
        .raw-data-table-container::-webkit-scrollbar-track {
            background: #f9fafb; 
            border-radius: 8px;
        }
        .scrollable-list::-webkit-scrollbar-thumb,
        .raw-data-table-container::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 8px;
        }
        .scrollable-list::-webkit-scrollbar-thumb:hover,
        .raw-data-table-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }
        #loading-message, #error-message {
            text-align: center;
            padding: 2rem;
            font-size: 1.25rem;
            border-radius: 0.5rem;
        }
        #loading-message {
            color: #4b5563; 
        }
        #error-message {
            color: #dc2626; 
            background-color: #fee2e2; 
            border: 1px solid #fecaca; 
        }
        .upcoming-trip-detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem; 
            font-size: 0.875rem; 
        }
        .upcoming-trip-detail-item svg {
            width: 1rem; 
            height: 1rem; 
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        .list-container {
            background-color: white;
            padding: 1rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
        }
        /* Styles for the raw data table */
        .raw-data-table-container {
            max-height: 400px; 
            overflow: auto;
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
        }
        .raw-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem; 
        }
        .raw-data-table th, .raw-data-table td {
            border: 1px solid #e5e7eb; 
            padding: 0.4rem 0.6rem; 
            text-align: left;
            white-space: nowrap; 
        }
        .raw-data-table th {
            background-color: #f9fafb; 
            font-weight: 600;
            position: sticky; 
            top: 0;
            z-index: 10;
        }
        /* Filter inputs styling */
        .filter-container {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 0.75rem; 
            align-items: end; 
        }
        .filter-grid input[type="text"], 
        .filter-grid input[type="date"],
        .filter-grid select,
        .filter-grid button { 
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            font-size: 0.875rem;
            box-sizing: border-box; 
            height: 38px; 
        }
        .filter-grid input[type="text"]:focus,
        .filter-grid input[type="date"]:focus,
        .filter-grid select:focus {
            outline: none;
            border-color: #6366f1; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .filter-grid button {
            background-color: #4f46e5; 
            color: white;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .filter-grid button:hover {
            background-color: #4338ca; 
        }
        .filter-grid button.clear-btn { 
            background-color: #6b7280; 
        }
        .filter-grid button.clear-btn:hover {
            background-color: #4b5563; 
        }
        .filter-label {
            font-size: 0.75rem; 
            color: #6b7280; 
            margin-bottom: 0.25rem;
            display: block;
        }

        /* Entrance Animation for main content */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-on-load {
            animation: fadeInSlideUp 0.8s ease-out forwards;
        }

        /* Entrance Animation for titles */
        @keyframes fadeInSlideUpSlight {
            from {
                opacity: 0;
                transform: translateY(10px); /* Slightly less vertical movement */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-title-load {
            opacity: 0; /* Start hidden to prevent flash before animation */
            animation: fadeInSlideUpSlight 0.6s ease-out forwards;
            /* animation-delay will be applied inline for staggering */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <header class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 animate-title-load" style="animation-delay: 0.1s;">Travel Dashboard</h1>
        <p class="text-gray-600 animate-title-load" style="animation-delay: 0.2s;">Summary of your travel activities <span id="as-of-date-info"></span></p>
    </header>

    <div id="loading-message" class="my-8">Loading data... Please wait.</div>
    <div id="error-message" class="my-8 hidden"></div>

    <div id="dashboard-content" class="hidden">
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
            <div class="scorecard">
                <div class="scorecard-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-blue-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" />
                    </svg>
                    <h2>Total Trips Booked</h2>
                </div>
                <p id="total-trips">0</p>
            </div>
            <div class="scorecard">
                <div class="scorecard-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-green-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008z" />
                    </svg>
                    <h2>Trips This Month (<span id="current-month-year-span"></span>)</h2>
                </div>
                <p id="trips-this-month">0</p>
            </div>
            <div class="scorecard">
                <div class="scorecard-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-purple-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                    <h2>Upcoming Trips</h2>
                </div>
                <p id="upcoming-trips-count">0</p>
            </div>
            <div class="scorecard">
                <div class="scorecard-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-red-500">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0H21m-9 6h9M12 9v2.25m-.75-2.25V6.75M12 12.75v2.25m0-2.25V10.5m0 2.25H4.5m0-2.25H3M3.75 9h.75M21 12h-9.375c1.026 0 1.95.184 2.75.519.424.177.852.377 1.28.608M21 12a9.06 9.06 0 01-9.375 9.375c-1.026 0-1.95-.184-2.75-.519-.424-.177-.852.377-1.28-.608M21 12.031V13.5A2.25 2.25 0 0118.75 15H3.75A2.25 2.25 0 011.5 12.75V12A2.25 2.25 0 013.75 9.75h4.019M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h2>Total Travel Spent</h2>
                </div>
                <p id="total-spent">₹0</p>
            </div>
            <div class="scorecard">
                <div class="scorecard-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-yellow-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                    </svg>
                    <h2>Net Cash to Agent</h2>
                </div>
                <p id="net-cash-to-agent">₹0</p>
            </div>
            <div class="scorecard">
                <div class="scorecard-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-indigo-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2>Net Amount (All Entries)</h2>
                </div>
                <p id="net-amount-all">₹0</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-8"> 
            <div class="lg:col-span-1 space-y-6">
                <div class="list-container">
                    <h3 class="section-title animate-title-load" style="animation-delay: 0.3s;">Trip Status</h3>
                    <ul id="trip-status-list" class="scrollable-list"></ul>
                </div>
                <div class="list-container">
                    <h3 class="section-title animate-title-load" style="animation-delay: 0.3s;">Top 5 Transport Providers</h3>
                    <ul id="top-providers-list" class="scrollable-list"></ul>
                </div>
            </div>

            <div class="lg:col-span-1 list-container"> 
                <h3 class="section-title animate-title-load" style="animation-delay: 0.3s;">Top 5 Destinations</h3>
                <ul id="top-destinations-list" class="scrollable-list"></ul>
            </div>
           
            <div class="lg:col-span-1 list-container">
                <h3 class="section-title animate-title-load" style="animation-delay: 0.3s;">Upcoming Trips Details</h3>
                <div id="upcoming-trips-details-list" class="scrollable-list">
                    <p class="text-gray-500 p-4">No upcoming trips found.</p>
                </div>
            </div>
        </section>

        <section class="mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-2 animate-title-load" style="animation-delay: 0.3s;">Raw Travel Data Filters</h3>
            <div class="filter-container mb-4">
                <div class="filter-grid">
                    <div>
                        <label for="filter-name" class="filter-label">Name</label>
                        <input type="text" id="filter-name" placeholder="Filter by Name...">
                    </div>
                    <div>
                        <label for="filter-travel-status-dropdown" class="filter-label">Travel Status</label>
                        <select id="filter-travel-status-dropdown">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-payment-status-dropdown" class="filter-label">Payment Status</label>
                        <select id="filter-payment-status-dropdown">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-transport-provider" class="filter-label">Provider</label>
                        <input type="text" id="filter-transport-provider" placeholder="Filter by Provider...">
                    </div>
                    <div>
                        <label for="filter-travel-date-start" class="filter-label">Travel Date From</label>
                        <input type="date" id="filter-travel-date-start">
                    </div>
                    <div>
                        <label for="filter-travel-date-end" class="filter-label">Travel Date To</label>
                        <input type="date" id="filter-travel-date-end">
                    </div>
                     <div>
                        <label class="filter-label invisible">Actions</label>
                        <button id="clear-filters-btn" class="clear-btn">Clear Filters</button>
                    </div>
                    <div>
                        <label class="filter-label invisible">Actions</label>
                        <button id="export-pdf-btn">Export to PDF</button>
                    </div>
                </div>
            </div>

            <div class="raw-data-table-container">
                <table class="raw-data-table" id="raw-data-table">
                    <thead id="raw-data-table-head">
                    </thead>
                    <tbody id="raw-data-table-body">
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <footer class="mt-12 text-center text-sm text-gray-500">
        <p>&copy; <span id="copyright-year"></span> Build Wealth Realtors. All rights reserved.</p>
    </footer>

    <script>
        // API Endpoint URL from Google Apps Script
        const API_URL = "https://script.googleusercontent.com/a/macros/buildwealthrealtors.com/echo?user_content_key=AehSKLjRwwF31mDO6V_VeYY49Cl4ncwzQMLNY9dB1K6VJGoAx3fAY1SkkU2fX26m1v3HeaejyQV61ZbVXRROzC1ytJDMqbm4_ER0Z-LpEiygXa3VZOCnrefPWYArG_NSdKxEJVwulyW5w3ymZe93c35UyQK1rOQX5fwdj1T4BRsIOpMcSHzsZTKrrvRFXyrCc7-KK_r2-CUhBf1nNwmktBG8lR-gAAXwBG1WAufapuBIOH7tQvERGwt9Wrk6Ji_C9qsi0NHWZUT4ovP2p9PLhSVdsZ-NjDiGF8-DCpbk2zC1mGKJAcoaFZ0_C1tIwWKhag_8Tj6XTIFu&lib=M2wWL_Nc6C98S-1dEGvC17PigwJZHSzuT";
       
        let allTravelRecords = []; 
        let currentTableHeaders = []; 

        // --- Helper Functions ---
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            return `₹${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
       
        // Formats a date string to "DD Mon YY" using the browser's local timezone.
        function formatToLocalDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return 'N/A';
            try {
                const date = new Date(dateString); 
                if (isNaN(date.getTime())) return 'Invalid Date String';
                return date.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric'
                });
            } catch (e) {
                console.error("Error in formatToLocalDate:", e, "Input:", dateString);
                return 'Format Error';
            }
        }

        function formatTravelDateForTable(dateString) {
            if (!dateString || typeof dateString !== 'string') return 'N/A';
            try {
                const localDatePart = formatToLocalDate(dateString); 
                if (localDatePart === 'Invalid Date' || localDatePart === 'Format Error' || localDatePart === 'N/A') {
                    return dateString; 
                }

                if (dateString.includes("T")) {
                    const date = new Date(dateString); 
                    if (isNaN(date.getTime())) return localDatePart; 

                    const hours = date.getUTCHours();
                    const minutes = date.getUTCMinutes();
                    const seconds = date.getUTCSeconds();
                    const isTimeSignificant = !( (hours === 0 && minutes === 0 && seconds === 0) ||
                                                 (hours === 18 && minutes === 30 && seconds === 0 && dateString.endsWith("T18:30:00.000Z")) );
                   
                    if (isTimeSignificant) {
                         const timePart = date.toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            hour12: true, 
                            timeZone: 'UTC' 
                        });
                        return `${localDatePart}, ${timePart}`;
                    }
                }
                return localDatePart; 
            } catch (e) {
                console.error("Error formatting travel date for table:", e, "Input:", dateString);
                return dateString; 
            }
        }
       
        // Formats time from an ISO string to HH:MM:SS AM/PM (UTC) AFTER SUBTRACTION
        function formatAdjustedUtcTimePart(dateString) {
            if (!dateString || typeof dateString !== 'string' || !dateString.includes('T')) return 'N/A';
            try {
                const ensuredUtcString = dateString.endsWith('Z') ? dateString : dateString + 'Z';
                let date = new Date(ensuredUtcString); 
                if (isNaN(date.getTime())) return 'Invalid Date String';

                // Subtract 18 hours, 38 minutes, 50 seconds
                date.setUTCHours(date.getUTCHours() - 18);
                date.setUTCMinutes(date.getUTCMinutes() - 38); 
                date.setUTCSeconds(date.getUTCSeconds() - 50);
               
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: true, 
                    timeZone: 'UTC' 
                });
            } catch (e) {
                console.error("Error formatting adjusted UTC time part:", e, "Input:", dateString);
                return 'Format Error';
            }
        }
       
        function getRawCityName(city) {
            if (!city || typeof city !== 'string') return 'Unknown';
            return city.trim().toUpperCase(); 
        }
       
        function getDisplayCityName(city) {
            if (!city || typeof city !== 'string') return 'N/A';
            return city.trim(); 
        }


        function renderDashboard(travelData) {
            allTravelRecords = travelData; 
            const today = new Date(); 
            const currentYear = today.getFullYear(); 
            const currentMonth = today.getMonth(); 

            const asOfDateInfoEl = document.getElementById('as-of-date-info');
            if (asOfDateInfoEl) {
                 asOfDateInfoEl.textContent = `(Data as of ${today.toLocaleDateString('en-GB', {day: 'numeric', month: 'short', year: 'numeric'})} for monthly/upcoming calculations)`;
            }
            const currentMonthYearSpanEl = document.getElementById('current-month-year-span');
            if(currentMonthYearSpanEl) {
                currentMonthYearSpanEl.textContent = `${today.toLocaleString('default', { month: 'short' })} '${String(currentYear).slice(-2)}`;
            }


            const icons = {
                completed: `<svg class="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                pending: `<svg class="w-5 h-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>`,
                notDone: `<svg class="w-5 h-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
                provider: `<svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z" /></svg>`, 
                destination: `<svg class="w-5 h-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>`,
                user: `<svg class="w-5 h-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`,
                calendar: `<svg class="w-5 h-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`,
                route: `<svg class="w-5 h-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.994 0H2.985m16.059 0v-4.992m0 0h-4.992m4.993 0l-3.181-3.183a8.25 8.25 0 00-11.667 0l-3.181 3.183m4.994 0H19.02" /></svg>`,
                pnr: `<svg class="w-5 h-5 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" /></svg>`
            };

            let totalTrips = 0;
            let tripsThisMonth = 0;
            let upcomingTripsCount = 0;
            let totalSpent = 0; 
            let netCashToAgent = 0; 
            let netAmountAllEntries = 0; 

            const tripStatusCounts = {};
            const destinationCounts = {}; 
            const providerCounts = {};
            const upcomingTripsList = [];
           
            const uniqueTravelStatuses = new Set();
            const uniquePaymentStatuses = new Set();

            currentTableHeaders = []; 
            if (travelData.length > 0) {
                Object.keys(travelData[0]).forEach(key => currentTableHeaders.push(key));
            }

            travelData.forEach(record => {
                const bookingAgent = record["Booking Agent Name"] ? String(record["Booking Agent Name"]).trim() : "";
                const pnr = record["PNR / Booking ref No."] ? String(record["PNR / Booking ref No."]).trim() : "";
                const transportProvider = record["Transport Provider"] ? String(record["Transport Provider"]).trim() : "";
                const amount = parseFloat(record["Amount"]) || 0; 
                const name = record["Name"] ? String(record["Name"]).trim() : "N/A"; 
                const travelStatus = String(record["Travel Status"] || '').trim();
                const paymentStatus = String(record["Payment Status"] || '').trim();

                if(travelStatus) uniqueTravelStatuses.add(travelStatus);
                if(paymentStatus) uniquePaymentStatuses.add(paymentStatus);

                netAmountAllEntries += amount;

                if (bookingAgent === "Cash Given (Kedia)") {
                    netCashToAgent += amount; 
                    if (!pnr && !transportProvider) { 
                        return;
                    }
                }

                if (pnr || transportProvider) {
                    totalTrips++;
                }
               
                if (amount > 0 && bookingAgent !== "Cash Given (Kedia)") {
                    totalSpent += amount;
                }

                if (record["Travel Date"]) {
                    try {
                        const recordDate = new Date(record["Travel Date"]); 
                        if (!isNaN(recordDate.getTime())) { 
                            if (recordDate.getFullYear() === currentYear && recordDate.getMonth() === currentMonth) {
                                tripsThisMonth++;
                            }
                           
                            const recordLocalDateOnly = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
                            const todayLocalDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                            if (recordLocalDateOnly.getTime() > todayLocalDateOnly.getTime()) {
                                upcomingTripsCount++;
                                upcomingTripsList.push({
                                    name: name, 
                                    date: formatToLocalDate(record["Travel Date"]), 
                                    source: getDisplayCityName(record["Source City"]),
                                    destination: getDisplayCityName(record["Destination City"]),
                                    pnr: pnr || "N/A",
                                    provider: transportProvider || "N/A"
                                });
                            }
                        }
                    } catch (e) { /* console.error("Error parsing travel date for logic:", record["Travel Date"], e); */ }
                }
               
                if (travelStatus && travelStatus !== "Unknown") { 
                    tripStatusCounts[travelStatus] = (tripStatusCounts[travelStatus] || 0) + 1;
                }

                const rawDestCity = getRawCityName(record["Destination City"]);
                 if (rawDestCity && rawDestCity !== 'UNKNOWN' && record["Destination City"] && String(record["Destination City"]).trim() !== "") {
                    destinationCounts[rawDestCity] = (destinationCounts[rawDestCity] || 0) + 1;
                }

                if (transportProvider && transportProvider !== "") { 
                    providerCounts[transportProvider] = (providerCounts[transportProvider] || 0) + 1;
                }
            });
           
            document.getElementById('total-trips').textContent = totalTrips;
            document.getElementById('trips-this-month').textContent = tripsThisMonth;
            document.getElementById('upcoming-trips-count').textContent = upcomingTripsCount;
            document.getElementById('total-spent').textContent = formatCurrency(totalSpent);
            document.getElementById('net-cash-to-agent').textContent = formatCurrency(netCashToAgent);
            document.getElementById('net-amount-all').textContent = formatCurrency(netAmountAllEntries);

            const statusListEl = document.getElementById('trip-status-list');
            statusListEl.innerHTML = ''; 
            if (Object.keys(tripStatusCounts).length > 0) {
                for (const status in tripStatusCounts) {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-item text-gray-700';
                    let iconHtml = '';
                    if (status.toLowerCase().includes('completed')) iconHtml = icons.completed;
                    else if (status.toLowerCase().includes('pending')) iconHtml = icons.pending;
                    else if (status.toLowerCase().includes('not done')) iconHtml = icons.notDone;
                    listItem.innerHTML = `${iconHtml}<span>${status}</span> <span class="font-semibold text-gray-900 ml-auto">${tripStatusCounts[status]}</span>`;
                    statusListEl.appendChild(listItem);
                }
            } else {
                 statusListEl.innerHTML = '<li class="list-item text-gray-500">No status data available.</li>';
            }
           
            const topDestinations = Object.entries(destinationCounts).sort(([,a],[,b]) => b-a).slice(0, 5); 
            const destListEl = document.getElementById('top-destinations-list');
            destListEl.innerHTML = '';
            if (topDestinations.length > 0) {
                topDestinations.forEach(([city, count]) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-item text-gray-700';
                    listItem.innerHTML = `${icons.destination}<span>${city}</span> <span class="font-semibold text-gray-900 ml-auto">${count}</span>`;
                    destListEl.appendChild(listItem);
                });
            } else {
                destListEl.innerHTML = '<li class="list-item text-gray-500">No destination data.</li>';
            }

            const topProviders = Object.entries(providerCounts).sort(([,a],[,b]) => b-a).slice(0, 5); 
            const providerListEl = document.getElementById('top-providers-list');
            providerListEl.innerHTML = '';
             if (topProviders.length > 0) {
                topProviders.forEach(([provider, count]) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-item text-gray-700';
                    listItem.innerHTML = `${icons.provider}<span>${provider}</span> <span class="font-semibold text-gray-900 ml-auto">${count}</span>`;
                    providerListEl.appendChild(listItem);
                });
            } else {
                providerListEl.innerHTML = '<li class="list-item text-gray-500">No provider data.</li>';
            }

            const upcomingTripsDetailsEl = document.getElementById('upcoming-trips-details-list');
            upcomingTripsDetailsEl.innerHTML = ''; 
            if (upcomingTripsList.length > 0) {
                upcomingTripsList.sort((a,b) => { 
                    const dateA = new Date(a.date.replace(/(\d{2}) (\w{3}) (\d{4})/, '$2 $1, $3'));
                    const dateB = new Date(b.date.replace(/(\d{2}) (\w{3}) (\d{4})/, '$2 $1, $3'));
                    return dateA - dateB;
                });
                upcomingTripsList.forEach(trip => {
                    const tripDiv = document.createElement('div');
                    tripDiv.className = 'py-2 px-1 border-b border-gray-200 last:border-b-0 text-sm'; 
                    tripDiv.innerHTML = `
                        <p class="upcoming-trip-detail-item font-semibold text-gray-800">${icons.user}${trip.name}</p>
                        <p class="upcoming-trip-detail-item text-gray-600">${icons.calendar}Date: ${trip.date}</p>
                        <p class="upcoming-trip-detail-item text-gray-600">${icons.route}Route: ${trip.source} -> ${trip.destination}</p> 
                        <p class="upcoming-trip-detail-item text-gray-600">${icons.provider}Provider: ${trip.provider} (${icons.pnr}PNR: ${trip.pnr})</p>
                    `;
                    upcomingTripsDetailsEl.appendChild(tripDiv);
                });
            } else {
                upcomingTripsDetailsEl.innerHTML = '<p class="text-gray-500 p-4">No upcoming trips found.</p>';
            }

            // Populate dropdowns
            const travelStatusDropdown = document.getElementById('filter-travel-status-dropdown');
            uniqueTravelStatuses.forEach(status => {
                if(status) { 
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    travelStatusDropdown.appendChild(option);
                }
            });

            const paymentStatusDropdown = document.getElementById('filter-payment-status-dropdown');
            uniquePaymentStatuses.forEach(status => {
                 if(status) { 
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    paymentStatusDropdown.appendChild(option);
                }
            });
           
            populateRawDataTable(allTravelRecords, currentTableHeaders);
        }

        function populateRawDataTable(dataToDisplay, headers) {
            const tableHeadEl = document.getElementById('raw-data-table-head');
            const tableBodyEl = document.getElementById('raw-data-table-body');
            tableHeadEl.innerHTML = ''; 
            tableBodyEl.innerHTML = ''; 

            if (headers.length > 0) {
                const headerRow = document.createElement('tr');
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                tableHeadEl.appendChild(headerRow);

                if (dataToDisplay.length > 0) {
                    dataToDisplay.forEach(record => {
                        const row = document.createElement('tr');
                        headers.forEach(header => {
                            const td = document.createElement('td');
                            let cellValue = record[header];
                           
                            if (header === "Ticket Booking Date") {
                                cellValue = formatToLocalDate(cellValue); 
                            } else if (header === "Travel Date") {
                                cellValue = formatTravelDateForTable(cellValue); 
                            } else if (header === "Departure Time" || header === "Arrival Time") {
                                cellValue = formatAdjustedUtcTimePart(cellValue); 
                            } else if (header.toLowerCase() === 'amount') {
                                const numAmount = parseFloat(String(cellValue).trim() === '' ? '0' : String(cellValue));
                                cellValue = formatCurrency(isNaN(numAmount) ? 0 : numAmount);
                            }

                            td.textContent = cellValue !== null && cellValue !== undefined ? String(cellValue) : '';
                            row.appendChild(td);
                        });
                        tableBodyEl.appendChild(row);
                    });
                } else {
                     tableBodyEl.innerHTML = '<tr><td colspan="' + headers.length + '" class="text-center p-4">No matching records found.</td></tr>';
                }
            } else {
                tableBodyEl.innerHTML = '<tr><td colspan="100%" class="text-center p-4">No data to display.</td></tr>';
            }
        }
       
        function applyTableFilters() {
            const filterName = document.getElementById('filter-name').value.toLowerCase();
            const filterTravelStatusDropdown = document.getElementById('filter-travel-status-dropdown').value;
            const filterPaymentStatusDropdown = document.getElementById('filter-payment-status-dropdown').value;
            const filterTransportProvider = document.getElementById('filter-transport-provider').value.toLowerCase();
            const filterTravelDateStart = document.getElementById('filter-travel-date-start').value;
            const filterTravelDateEnd = document.getElementById('filter-travel-date-end').value;

            const startDate = filterTravelDateStart ? new Date(filterTravelDateStart) : null;
            const endDate = filterTravelDateEnd ? new Date(filterTravelDateEnd) : null;
            if(startDate) startDate.setHours(0,0,0,0); 
            if(endDate) endDate.setHours(23,59,59,999); 


            const filteredData = allTravelRecords.filter(record => {
                const name = String(record["Name"] || '').toLowerCase();
                const travelStatus = String(record["Travel Status"] || ''); 
                const paymentStatus = String(record["Payment Status"] || ''); 
                const transportProvider = String(record["Transport Provider"] || '').toLowerCase();
               
                let travelDateMatch = true;
                if (record["Travel Date"]) {
                    try {
                        const recordDateObj = new Date(record["Travel Date"]); 
                        if (!isNaN(recordDateObj.getTime())) {
                            const recordLocalDate = new Date(recordDateObj.getFullYear(), recordDateObj.getMonth(), recordDateObj.getDate());

                            if (startDate && recordLocalDate < startDate) {
                                travelDateMatch = false;
                            }
                            if (endDate && recordLocalDate > endDate) {
                                travelDateMatch = false;
                            }
                        } else {
                            if (startDate || endDate) travelDateMatch = false; 
                        }
                    } catch (e) {
                        if (startDate || endDate) travelDateMatch = false; 
                    }
                } else {
                     if (startDate || endDate) travelDateMatch = false; 
                }

                return name.includes(filterName) &&
                       (filterTravelStatusDropdown === "" || travelStatus === filterTravelStatusDropdown) &&
                       (filterPaymentStatusDropdown === "" || paymentStatus === filterPaymentStatusDropdown) &&
                       transportProvider.includes(filterTransportProvider) &&
                       travelDateMatch;
            });
            populateRawDataTable(filteredData, currentTableHeaders);
        }

        function clearAllFilters() {
            document.getElementById('filter-name').value = '';
            document.getElementById('filter-travel-status-dropdown').value = '';
            document.getElementById('filter-payment-status-dropdown').value = '';
            document.getElementById('filter-transport-provider').value = '';
            document.getElementById('filter-travel-date-start').value = '';
            document.getElementById('filter-travel-date-end').value = '';
            applyTableFilters(); 
        }

        function exportTableToPDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF library is not loaded correctly.");
                alert("Error: PDF generation library (jsPDF) not loaded. Please check your internet connection or try again later.");
                return;
            }

            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF({ 
                orientation: 'landscape',
                unit: 'pt', 
                format: 'a4'
            });

            if (typeof doc.autoTable !== 'function') { 
                 console.error("jsPDF-AutoTable plugin is not loaded correctly or not attached to jsPDF instance.");
                alert("Error: PDF generation plugin (jsPDF-AutoTable) not available. Please check your internet connection or try again later.");
                return;
            }


            const table = document.getElementById('raw-data-table'); 
            if (!table) {
                console.error("Raw data table element not found for PDF export. Expected ID: raw-data-table");
                alert("Error: Could not find the data table to export.");
                return;
            }

            const headers = [];
            const tableHead = table.querySelector('thead');
            if (tableHead) {
                tableHead.querySelectorAll('th').forEach(th => headers.push(th.innerText));
            }
           
            const body = [];
            const tableBody = table.querySelector('tbody');
            if (tableBody) {
                tableBody.querySelectorAll('tr').forEach(tr => {
                    const firstCellText = tr.cells.length > 0 ? tr.cells[0].innerText.trim() : "";
                    if (tr.cells.length === 1 && (firstCellText === "No matching records found." || firstCellText === "No data to display.")) {
                        return; 
                    }
                    const rowData = [];
                    tr.querySelectorAll('td').forEach(td => rowData.push(td.innerText));
                    if(rowData.length > 0) { 
                        body.push(rowData);
                    }
                });
            }

            if (headers.length === 0 && body.length === 0) {
                alert("No data to export. The table appears to be empty or headers are missing."); 
                return;
            }
             if (headers.length === 0 ) {
                alert("Table headers are missing. Cannot generate PDF.");
                return;
            }
            if (body.length === 0) {
                alert("No data rows to export. The table body is empty.");
                return;
            }

            doc.autoTable({
                head: [headers], 
                body: body,
                startY: 20,
                theme: 'grid', 
                styles: {
                    fontSize: 7, 
                    cellPadding: 2,
                    overflow: 'linebreak' 
                },
                headStyles: {
                    fillColor: [22, 160, 133], 
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: { 
                    ...(headers.indexOf('Amount') !== -1 && { [headers.indexOf('Amount')]: { halign: 'right' } })
                },
                didDrawPage: function (data) { 
                    doc.setFontSize(8);
                    doc.text('Page ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            try {
                doc.save('travel_data.pdf');
            } catch (e) {
                console.error("Error saving PDF:", e);
                alert("An error occurred while trying to save the PDF. Please check the console for details.");
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            const loadingMessageEl = document.getElementById('loading-message');
            const errorMessageEl = document.getElementById('error-message');
            const dashboardContentEl = document.getElementById('dashboard-content');

            const copyrightYearEl = document.getElementById('copyright-year');
            if(copyrightYearEl) {
                copyrightYearEl.textContent = new Date().getFullYear();
            }


            fetch(API_URL)
                .then(response => {
                    if (!response.ok) { 
                        throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    }
                    return response.json(); 
                })
                .then(data => {
                    loadingMessageEl.classList.add('hidden'); 
                    dashboardContentEl.classList.remove('hidden'); 
                    dashboardContentEl.classList.add('animate-on-load'); // Add animation class to main content
                    renderDashboard(data); 

                    document.getElementById('filter-name').addEventListener('input', applyTableFilters);
                    document.getElementById('filter-travel-status-dropdown').addEventListener('change', applyTableFilters);
                    document.getElementById('filter-payment-status-dropdown').addEventListener('change', applyTableFilters);
                    document.getElementById('filter-transport-provider').addEventListener('input', applyTableFilters);
                    document.getElementById('filter-travel-date-start').addEventListener('change', applyTableFilters);
                    document.getElementById('filter-travel-date-end').addEventListener('change', applyTableFilters);
                    document.getElementById('clear-filters-btn').addEventListener('click', clearAllFilters);
                    document.getElementById('export-pdf-btn').addEventListener('click', exportTableToPDF);
                })
                .catch(error => { 
                    console.error('Error fetching or processing travel data:', error);
                    loadingMessageEl.classList.add('hidden'); 
                    errorMessageEl.textContent = `Error loading dashboard: ${error.message}. Please check the API endpoint, data format, and CORS configuration.`;
                    errorMessageEl.classList.remove('hidden'); 
                });
           
        });
    </script>
</body>
</html>